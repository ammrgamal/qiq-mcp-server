# Example Nginx config for mcp.quickitquote.com
# Ensures /mcp/http always returns JSON and proxies to Vercel (or your origin)
# Adjust upstream (proxy_pass) to your deployment target.

server {
    listen 443 ssl http2;
    server_name mcp.quickitquote.com;

    # TLS config omitted for brevity

    # Prevent default HTML error pages for the MCP HTTP endpoint
    location = /mcp/http {
        # Always treat content as JSON
        default_type application/json;

        # Pass through important headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Do not buffer large JSON bodies; helpful for logs
        proxy_request_buffering off;
        client_max_body_size 2m;

        # Upstream to Vercel (replace with your origin)
        proxy_pass https://<your-vercel-deployment>.vercel.app/mcp/http;

        # Never show HTML error pages; return JSON
        error_page 400 401 403 404 405 500 502 503 504 = @json_error;
    }

    location @json_error {
        internal;
        default_type application/json;
        return 200 '{"error":{"code":"upstream_error","message":"Upstream error or bad request"}}';
    }

    # WebSocket upgrade for /mcp (if you proxy WS via Nginx)
    location = /mcp {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_pass https://<your-vercel-deployment>.vercel.app/mcp;
    }
}
